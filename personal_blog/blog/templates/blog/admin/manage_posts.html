{% extends 'blog/base_admin.html' %}
{% block title %}Manage Posts | Admin{% endblock %}

{% block content %}

<h2 class="fw-semibold mb-4 text-center">Manage Posts</h2>

<div class="container">

  <!-- ðŸ”Ž Filters & Search Form -->
  <form method="get" class="row g-3 mb-4">

    <div class="col-md-4">
      <input type="text" name="search" class="form-control"
             placeholder="Search posts..." value="{{ search }}">
    </div>

    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">Filter by Status</option>
        <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
      </select>
    </div>

    <div class="col-md-3">
      <select name="sort" class="form-select">
        <option value="">Sort: Newest First</option>
        <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest First</option>
      </select>
    </div>

    <div class="col-md-2 d-grid">
      <button class="btn btn-primary"><i class="bi bi-funnel"></i> Apply</button>
    </div>

  </form>

  {% if search or status_filter or sort %}
    <a href="{% url 'manage_posts' %}" class="btn btn-sm btn-outline-secondary mb-3">
      <i class="bi bi-arrow-counterclockwise"></i> Reset Filters
    </a>
  {% endif %}

  <!-- ðŸ“Œ BULK ACTIONS FORM -->
  <form method="post">
    {% csrf_token %}

    <div class="d-flex justify-content-between align-items-center mb-3">

      <!-- Bulk action -->
      <div class="d-flex gap-2">
        <select name="bulk_action" class="form-select w-auto">
          <option value="" disabled selected>Bulk Actions</option>
          <option value="publish">Mark as Published</option>
          <option value="pending">Mark as Pending</option>
          <option value="draft">Mark as Draft</option>
          <option value="delete">Delete Selected</option>
        </select>

        <button class="btn btn-dark" type="submit">
          <i class="bi bi-check2-all"></i> Apply
        </button>
      </div>

      <span class="text-muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    </div>

    <!-- POSTS TABLE -->
    <div class="table-responsive shadow-sm rounded">
      <table class="table table-hover align-middle">

        <thead class="table-primary">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Title</th>
            <th>Author</th>
            <th>Date</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>

        <tbody>

          {% for post in posts %}

          <tr class="
            {% if post.status == 'published' %}table-success
            {% elif post.status == 'pending' %}table-warning
            {% elif post.status == 'draft' %}table-danger
            {% endif %}
          ">
            <td>
              <input type="checkbox" name="selected_posts" value="{{ post.id }}" class="selectBox">
            </td>

            <td class="fw-semibold">{{ post.title }}</td>
            <td>{{ post.author|default:"Anonymous" }}</td>
            <td>{{ post.created_at|date:"M d, Y" }}</td>

            <td>
              {% if post.status == "published" %}
                <span class="badge bg-success">Published</span>
              {% elif post.status == "pending" %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif post.status == "draft" %}
                <span class="badge bg-danger">Draft</span>
              {% endif %}
            </td>

            <td class="text-center">
              <a href="{% url 'view_post' post.id %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye"></i>
              </a>
              <a href="{% url 'edit_post' post.id %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{% url 'delete_post' post.id %}"
                 class="btn btn-sm btn-outline-danger"
                 data-confirm
                 data-url="{% url 'delete_post' post.id %}"
                 data-message="Delete post '{{ post.title }}'?">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>

          {% empty %}
          <tr><td colspan="6" class="text-center text-muted">No posts found.</td></tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

  </form>

  <!-- PAGINATION -->
  {% if page_obj.has_other_pages %}
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">

      <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
        <a class="page-link"
           href="?page={{ page_obj.previous_page_number }}&search={{ search }}&status={{ status_filter }}&sort={{ sort }}">
          Previous
        </a>
      </li>

      {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link"
           href="?page={{ num }}&search={{ search }}&status={{ status_filter }}&sort={{ sort }}">
          {{ num }}
        </a>
      </li>
      {% endfor %}

      <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
        <a class="page-link"
           href="?page={{ page_obj.next_page_number }}&search={{ search }}&status={{ status_filter }}&sort={{ sort }}">
          Next
        </a>
      </li>

    </ul>
  </nav>
  {% endif %}

</div>

<!-- JS: Select All -->
<script>
document.getElementById("selectAll").addEventListener("click", function() {
  let checkboxes = document.querySelectorAll(".selectBox");
  checkboxes.forEach(cb => cb.checked = this.checked);
});
</script>

{% endblock %}

